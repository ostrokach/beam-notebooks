#!/bin/bash

set -ev

# Update jupyterlab version and install labextensions
conda install -yq 'jupyterlab>=1.0' jupyter-server-proxy jupyterlab_code_formatter black 
jupyter labextension install -y --no-build @jupyter-widgets/jupyterlab-manager
jupyter labextension install -y --no-build @jupyterlab/toc
jupyter labextension install -y --no-build jupyterlab_bokeh
jupyter labextension install -y --no-build @ryantam626/jupyterlab_code_formatter
jupyter lab build --minimize=False
jupyter serverextension enable --py jupyterlab_code_formatter
jupyter serverextension enable jupyter_server_proxy

mkdir -p opt

pushd opt
wget --quiet http://apache.forsale.plus/flink/flink-1.9.1/flink-1.9.1-bin-scala_2.11.tgz && tar -xf flink-1.9.1-bin-scala_2.11.tgz
wget --quiet http://apache.forsale.plus/kafka/2.3.1/kafka_2.11-2.3.1.tgz && tar -xf kafka_2.11-2.3.1.tgz
popd

git clone https://github.com/apache/beam.git
cd beam
git checkout release-2.17.0

gradle "runners:flink:1.9:job-server:shadowJar" --info
mkdir -p "/srv/conda/envs/notebook/lib/runners/flink/1.9/job-server/build/libs/"
mv runners/flink/1.9/job-server/build/libs/*.jar "/srv/conda/envs/notebook/lib/runners/flink/1.9/job-server/build/libs/"

pushd sdks/python
python -m pip install -e .[gcp]
popd
