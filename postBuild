#!/bin/bash

set -ev

# Update jupyterlab version and install labextensions
conda install -yq 'jupyterlab>=1.0' jupyterlab_code_formatter black
jupyter labextension install @jupyter-widgets/jupyterlab-manager 
jupyter labextension install @jupyterlab/toc
jupyter labextension install jupyterlab_bokeh
jupyter labextension install @ryantam626/jupyterlab_code_formatter
jupyter serverextension enable --py jupyterlab_code_formatter

mkdir -p opt

pushd opt
wget --quiet http://apache.forsale.plus/flink/flink-1.9.1/flink-1.9.1-bin-scala_2.11.tgz && tar -xf flink-1.9.1-bin-scala_2.11.tgz
wget --quiet http://apache.forsale.plus/kafka/2.3.1/kafka_2.11-2.3.1.tgz && tar -xf kafka_2.11-2.3.1.tgz
wget --quiet https://bin.equinox.io/c/4VmDzA7iaHb/ngrok-stable-linux-amd64.zip && unzip ngrok-stable-linux-amd64.zip && rm ngrok-stable-linux-amd64.zip
popd

curl "https://codeload.github.com/apache/beam/zip/release-2.17.0" -o beam-release-2.17.0.zip
unzip beam-release-2.17.0

pushd beam-release-2.17.0
gradle "runners:flink:1.9:job-server:shadowJar" --info
mkdir -p "/srv/conda/envs/notebook/lib/runners/flink/1.9/job-server/build/libs/"
mv runners/flink/1.9/job-server/build/libs/*.jar "/srv/conda/envs/notebook/lib/runners/flink/1.9/job-server/build/libs/"
pushd sdks/python
python -m pip install . --no-deps --ignore-installed -vv
popd
popd
